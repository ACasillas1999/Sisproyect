<main class="app-shell">
  <app-sidebar></app-sidebar>

  <section class="main">
    <header class="page-header">
      <div>
        <p class="eyebrow">Métricas del equipo</p>
        <h1>{{ currentDepartment()?.name }} | Métricas del equipo</h1>
        <p class="muted">Estadísticas calculadas para {{ currentDepartment()?.name }}</p>
      </div>
      <div class="header-capsule">
        @if (isAdmin()) {
          <span class="label">Seleccionar Departamento</span>
          <select class="dept-selector" [(ngModel)]="selectedDepartmentId" (ngModelChange)="selectDepartment($event)">
            @for (dept of departments(); track dept.id) {
              <option [value]="dept.id">{{ dept.name }}</option>
            }
          </select>
        } @else {
          <span class="label">Departamento activo</span>
          <div class="pill strong">
            <span class="dot" [style.background]="currentDepartment()?.color ?? '#22d3ee'"></span>
            {{ currentDepartment()?.name }}
          </div>
        }
      </div>
    </header>

    <section class="metrics-grid">
      <article class="metric-card">
        <div class="metric-label">Progreso</div>
        <div class="metric-value">{{ departmentMetrics().progress }}%</div>
        <div class="progress big">
          <div
            class="progress-bar"
            [style.width]="departmentMetrics().progress + '%'"
            [style.background]="currentDepartment()?.color ?? '#22d3ee'"
          ></div>
        </div>
        <p class="muted">Tareas completadas vs total del equipo</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Tareas abiertas</div>
        <div class="metric-value">{{ departmentMetrics().pending + departmentMetrics().inProgress }}</div>
        <p class="muted">{{ departmentMetrics().pending }} pendientes | {{ departmentMetrics().inProgress }} en progreso</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Vencidas</div>
        <div class="metric-value alert-text">{{ departmentMetrics().overdue }}</div>
        <p class="muted">No cuentan tareas cerradas, revisar prioridades</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Prox. 7 dias</div>
        <div class="metric-value">{{ departmentMetrics().nearDue }}</div>
        <p class="muted">Tareas del equipo que vencen en la semana</p>
      </article>
    </section>

    <!-- Analytics Section -->
    <section class="analytics-section">
      <article class="panel analytics-card">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Grafica</p>
            <h3>Completadas Últimos 7 días</h3>
          </div>
        </div>
        <div class="burndown-chart">
          @for (day of burndownData(); track day.date) {
            <div class="chart-bar">
              <div class="bar-container">
                <div class="bar" [style.height.%]="getBarHeight(day.completed)" [style.background]="currentDepartment()?.color ?? '#22d3ee'">
                  @if (day.completed > 0) {
                    <span class="bar-value">{{ day.completed }}</span>
                  }
                </div>
              </div>
              <div class="bar-label">{{ day.day }}</div>
            </div>
          }
        </div>
        <p class="muted">Tareas completadas por día en los últimos 7 días</p>
      </article>

      <article class="panel analytics-card">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Velocidad</p>
            <h3>Métricas de Productividad</h3>
          </div>
        </div>
        <div class="velocity-metrics">
          <div class="velocity-card">
            <div class="velocity-label">Velocidad (por semana)</div>
            <div class="velocity-value" [style.color]="currentDepartment()?.color ?? '#22d3ee'">{{ velocity() }} tareas</div>
            <p class="muted">Promedio de las últimas 2 semanas</p>
          </div>
          <div class="velocity-card">
            <div class="velocity-label">Completadas última semana</div>
            <div class="velocity-value" [style.color]="currentDepartment()?.color ?? '#22d3ee'">{{ completedTasksLastWeek() }}</div>
            <p class="muted">Tareas cerradas en los últimos 7 días</p>
          </div>
          <div class="velocity-card">
            <div class="velocity-label">Completadas último mes</div>
            <div class="velocity-value" [style.color]="currentDepartment()?.color ?? '#22d3ee'">{{ completedTasksLastMonth() }}</div>
            <p class="muted">Tareas cerradas en los últimos 30 días</p>
          </div>
          <div class="velocity-card">
            <div class="velocity-label">Tiempo promedio</div>
            <div class="velocity-value" [style.color]="currentDepartment()?.color ?? '#22d3ee'">{{ averageCompletionTime() }} días</div>
            <p class="muted">Desde creación hasta completado</p>
          </div>
        </div>
      </article>
    </section>

    <!-- Resumen de Departamento -->
    <section class="department-summary">
      <article class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Resumen de {{ currentDepartment()?.name }}</p>
            <h3>Vista General</h3>
          </div>
        </div>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-icon" [style.background]="currentDepartment()?.color ?? '#22d3ee'">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="22 4 12 14.01 9 11.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="summary-content">
              <div class="summary-label">Total Tareas Completadas</div>
              <div class="summary-value">{{ departmentMetrics().done }}</div>
              <div class="summary-detail">De {{ departmentMetrics().total }} tareas totales</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon warning">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <line x1="12" y1="8" x2="12" y2="12" stroke-width="2" stroke-linecap="round"/>
                <line x1="12" y1="16" x2="12.01" y2="16" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="summary-content">
              <div class="summary-label">Tareas Vencidas</div>
              <div class="summary-value alert-text">{{ departmentMetrics().overdue }}</div>
              <div class="summary-detail">Requieren atención inmediata</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon info">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="summary-content">
              <div class="summary-label">Productividad</div>
              <div class="summary-value">{{ velocity() }}</div>
              <div class="summary-detail">Tareas por semana</div>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon success">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <polyline points="12 6 12 12 16 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="summary-content">
              <div class="summary-label">Tiempo Promedio</div>
              <div class="summary-value">{{ averageCompletionTime() }}</div>
              <div class="summary-detail">Días para completar</div>
            </div>
          </div>
        </div>
      </article>
    </section>
  </section>
</main>
