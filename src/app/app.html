<main class="app-shell">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-mark">SP</div>
      <div>
        <p class="eyebrow">Sisproyect</p>
        <p class="muted">Seguimiento por equipo</p>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="section-header">
        <span>Departamentos</span>
        <span class="chip">Foco en equipo</span>
      </div>
      @for (dept of departmentSummaries(); track dept.id) {
        <button
          class="dept-item"
          type="button"
          [class.active]="dept.id === selectedDepartmentId()"
          (click)="selectDepartment(dept.id)"
        >
          <span class="dot" [style.background]="dept.color"></span>
          <div class="dept-info">
            <div class="dept-name">{{ dept.name }}</div>
            <div class="dept-meta">Progreso {{ dept.progress }}% | {{ dept.open }} abiertas</div>
            <div class="progress">
              <div class="progress-bar" [style.width]="dept.progress + '%'" [style.background]="dept.color"></div>
            </div>
          </div>
          <span class="pill" [class.alert]="dept.overdue > 0">{{ dept.overdue }} vencidas</span>
        </button>
      }
    </div>

    <div class="sidebar-actions">
      <button class="primary-btn" type="button">+ Nuevo proyecto</button>
      <button class="ghost-btn" type="button">+ Nueva tarea</button>
    </div>
  </aside>

  <section class="main">
    <header class="page-header">
      <div>
        <p class="eyebrow">Dashboard | por departamento</p>
        <h1>{{ currentDepartment()?.name }} | desempeno de equipo</h1>
        <p class="muted">Avance calculado por departamento, no por agente.</p>
      </div>
      <div class="header-capsule">
        <span class="label">Departamento activo</span>
        <div class="pill strong">
          <span class="dot" [style.background]="currentDepartment()?.color ?? '#22d3ee'"></span>
          {{ currentDepartment()?.name }}
        </div>
      </div>
    </header>

    <section class="metrics-grid">
      <article class="metric-card">
        <div class="metric-label">Progreso</div>
        <div class="metric-value">{{ departmentMetrics().progress }}%</div>
        <div class="progress big">
          <div
            class="progress-bar"
            [style.width]="departmentMetrics().progress + '%'"
            [style.background]="currentDepartment()?.color ?? '#22d3ee'"
          ></div>
        </div>
        <p class="muted">Tareas completadas vs total del equipo</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Tareas abiertas</div>
        <div class="metric-value">{{ departmentMetrics().pending + departmentMetrics().inProgress }}</div>
        <p class="muted">{{ departmentMetrics().pending }} pendientes | {{ departmentMetrics().inProgress }} en progreso</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Vencidas</div>
        <div class="metric-value alert-text">{{ departmentMetrics().overdue }}</div>
        <p class="muted">No cuentan tareas cerradas; revisar prioridades</p>
      </article>
      <article class="metric-card">
        <div class="metric-label">Prox. 7 dias</div>
        <div class="metric-value">{{ departmentMetrics().nearDue }}</div>
        <p class="muted">Tareas del equipo que vencen en la semana</p>
      </article>
    </section>

    <section class="content-grid">
      <article class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Proyectos</p>
            <h3>Avance por proyecto</h3>
          </div>
          <span class="chip">Depto: {{ currentDepartment()?.name }}</span>
        </div>

        <div class="project-list">
          @for (project of projectSummaries(); track project.id) {
            <div class="project-card">
              <div class="project-top">
                <div>
                  <div class="project-name">{{ project.name }}</div>
                  <div class="project-meta">{{ project.description }}</div>
                </div>
                <span class="pill soft">{{ project.done }}/{{ project.total }} hechas</span>
              </div>
              <div class="project-progress">
                <div class="progress">
                  <div
                    class="progress-bar"
                    [style.width]="project.progress + '%'"
                    [style.background]="currentDepartment()?.color ?? '#22d3ee'"
                  ></div>
                </div>
                <div class="project-stats">
                  <span>{{ project.progress }}%</span>
                  <span>{{ project.open }} abiertas</span>
                  <span [class.alert-text]="project.overdue > 0">{{ project.overdue }} vencidas</span>
                </div>
              </div>
            </div>
          }
        </div>
      </article>

      <article class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Tareas</p>
            <h3>Tablero por estado</h3>
          </div>
        </div>

        <div class="board-grid">
          <div class="column">
            <div class="column-header">
              <span class="dot small pending"></span>
              <div>Por hacer</div>
              <span class="pill">{{ boardColumns().pending.length }}</span>
            </div>
            <div class="column-body">
              @if (boardColumns().pending.length === 0) {
                <p class="muted small">Sin tareas pendientes</p>
              }
              @for (task of boardColumns().pending; track task.id) {
                <div class="task-card">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta">
                    <span class="badge low">Prioridad {{ task.priority }}</span>
                    <span class="badge ghost">{{ projectName(task.projectId) }}</span>
                  </div>
                  <div class="task-due">Vence {{ task.due }}</div>
                </div>
              }
            </div>
          </div>

          <div class="column">
            <div class="column-header">
              <span class="dot small progress"></span>
              <div>En progreso</div>
              <span class="pill">{{ boardColumns().inProgress.length }}</span>
            </div>
            <div class="column-body">
              @if (boardColumns().inProgress.length === 0) {
                <p class="muted small">Sin tareas en progreso</p>
              }
              @for (task of boardColumns().inProgress; track task.id) {
                <div class="task-card">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta">
                    <span class="badge mid">Prioridad {{ task.priority }}</span>
                    <span class="badge ghost">{{ projectName(task.projectId) }}</span>
                  </div>
                  <div class="task-due">Vence {{ task.due }}</div>
                </div>
              }
            </div>
          </div>

          <div class="column">
            <div class="column-header">
              <span class="dot small done"></span>
              <div>Completado</div>
              <span class="pill">{{ boardColumns().done.length }}</span>
            </div>
            <div class="column-body">
              @if (boardColumns().done.length === 0) {
                <p class="muted small">Aun sin tareas cerradas</p>
              }
              @for (task of boardColumns().done; track task.id) {
                <div class="task-card">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta">
                    <span class="badge success">Prioridad {{ task.priority }}</span>
                    <span class="badge ghost">{{ projectName(task.projectId) }}</span>
                  </div>
                  <div class="task-due">Cerrada {{ task.due }}</div>
                </div>
              }
            </div>
          </div>
        </div>
      </article>

      <article class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Usuarios</p>
            <h3>CRUD y login</h3>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-card">
            <h4>Crear usuario</h4>
            <div class="form-control">
              <label>Email</label>
              <input type="email" [(ngModel)]="newUser.email" placeholder="correo@empresa.com" />
            </div>
            <div class="form-control">
              <label>Password</label>
              <input type="password" [(ngModel)]="newUser.password" placeholder="Min 6 caracteres" />
            </div>
            <div class="form-control">
              <label>Rol</label>
              <select [(ngModel)]="newUser.role">
                <option value="admin">admin</option>
                <option value="lider">lider</option>
                <option value="usuario">usuario</option>
              </select>
            </div>
            <button class="primary-btn" type="button" (click)="createUser()">Crear usuario</button>
          </div>

          <div class="form-card">
            <h4>Login</h4>
            <div class="form-control">
              <label>Email</label>
              <input type="email" [(ngModel)]="loginForm.email" placeholder="correo@empresa.com" />
            </div>
            <div class="form-control">
              <label>Password</label>
              <input type="password" [(ngModel)]="loginForm.password" placeholder="Ingresa tu password" />
            </div>
            <button class="ghost-btn" type="button" (click)="login()">Login</button>
            <p class="muted" *ngIf="loginMessage()">{{ loginMessage() }}</p>
          </div>
        </div>

        <div class="users-table">
          <div class="users-header">
            <span>Correo</span>
            <span>Rol</span>
            <span>Acciones</span>
          </div>
          @for (user of users(); track user.id) {
            <div class="users-row">
              <span>{{ user.email }}</span>
              <span class="badge ghost">{{ user.role }}</span>
              <button class="danger-btn" type="button" (click)="deleteUser(user.id)">Eliminar</button>
            </div>
          }
          @if (users().length === 0) {
            <p class="muted small">Sin usuarios registrados</p>
          }
        </div>
      </article>
    </section>
  </section>
</main>
<router-outlet />
